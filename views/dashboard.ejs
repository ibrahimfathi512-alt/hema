<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talabat Pro | AI Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ff5e00;
            --primary-light: #ff8533;
            --bg-gradient: radial-gradient(circle at top right, #1e293b, #070b14);
            --sidebar-bg: rgba(15, 23, 42, 0.98);
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f1c40f;
            --sidebar-width: 260px;
        }

        [data-theme="light"] {
            --bg-gradient: radial-gradient(circle at top right, #f1f5f9, #e2e8f0);
            --sidebar-bg: rgba(255, 255, 255, 0.98);
            --card-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
            --text-main: #1e293b;
            --text-dim: #64748b;
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: var(--bg-gradient); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; overflow-x: hidden; padding-bottom: 70px; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); background: var(--sidebar-bg); backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border); padding: 20px; display: flex;
            flex-direction: column; position: fixed; height: 100vh; right: 0; z-index: 2000;
        }
        .nav-item { color: var(--text-dim); text-decoration: none; padding: 12px 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 0.9rem; }
        .nav-item:hover, .nav-item.active { background: rgba(255, 94, 0, 0.1); color: var(--primary); }

        /* Main Content */
        .main-content { margin-right: var(--sidebar-width); flex: 1; padding: 20px; width: calc(100% - var(--sidebar-width)); }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(105%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; }
        }

        /* Top Header (Welcome & Clock) */
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--glass-border); }
        .clock-box { text-align: left; }
        #clock { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        #date { color: var(--text-dim); font-size: 0.9rem; }

        /* Stats Grid */
        .smart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; text-align: center; cursor: pointer; border-bottom: 4px solid transparent; }
        .stat-card.active { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(255, 94, 0, 0.2); }
        .stat-card h2 { margin: 8px 0; font-size: 2rem; font-weight: 800; }

        /* Floating Center Button (Mobile) */
        .fab-center { 
            position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); 
            width: 65px; height: 65px; background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%; display: none; justify-content: center; align-items: center; 
            z-index: 3000; box-shadow: 0 15px 35px rgba(255, 94, 0, 0.5); color: #fff; 
            font-size: 28px; cursor: pointer; border: 3px solid rgba(255,255,255,0.3);
            animation: pulse-orange 2s infinite;
        }

        /* AI Chat Box */
        .ai-chat-fab { position: fixed; bottom: 85px; left: 30px; width: 55px; height: 55px; background: #007bff; border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 3000; cursor: pointer; color: #fff; box-shadow: 0 10px 25px rgba(0,123,255,0.4); }
        .chat-container { position: fixed; bottom: 155px; left: 30px; width: 320px; height: 450px; background: var(--sidebar-bg); border: 1px solid var(--glass-border); border-radius: 24px; display: none; flex-direction: column; z-index: 4000; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .chat-header { background: #007bff; padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 85%; font-size: 0.85rem; }
        .msg.bot { background: rgba(255,255,255,0.05); align-self: flex-start; }
        .msg.user { background: var(--primary); align-self: flex-end; }
        .chat-input { padding: 15px; border-top: 1px solid var(--glass-border); display: flex; gap: 10px; }
        .chat-input input { flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 10px; padding: 10px; color: white; outline: none; }

        /* News Ticker Bottom Bar */
        .news-ticker { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; color: #fff; height: 45px; display: flex; align-items: center; z-index: 5000; overflow: hidden; border-top: 2px solid var(--primary); }
        .ticker-title { background: var(--primary); padding: 0 15px; height: 100%; display: flex; align-items: center; font-weight: bold; font-size: 0.8rem; z-index: 2; white-space: nowrap; }
        .ticker-wrap { flex: 1; overflow: hidden; }
        .ticker-content { display: inline-block; white-space: nowrap; animation: ticker 45s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .ticker-item { display: inline-block; margin: 0 25px; font-size: 0.85rem; }

        /* Table Card */
        .table-card { background: var(--card-bg); border-radius: 20px; overflow-x: auto; border: 1px solid var(--glass-border); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { padding: 15px; color: var(--primary); background: rgba(0,0,0,0.1); cursor: pointer; text-align: center; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid var(--glass-border); text-align: center; font-size: 0.85rem; }

        @media (max-width: 992px) { .fab-center { display: flex; } }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(255, 94, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 94, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 94, 0, 0); } }
    </style>
</head>
<body data-theme="dark">

    <div class="fab-center" onclick="toggleSidebar()"><i class="fa-solid fa-plus"></i></div>

    <div class="ai-chat-fab" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
    <div class="chat-container" id="chatBox">
        <div class="chat-header"><span>Ù…Ø³Ø§Ø¹Ø¯ ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø°ÙƒÙŠ ğŸ¤–</span><i class="fa-solid fa-xmark" onclick="toggleChat()" style="cursor:pointer"></i></div>
        <div class="chat-messages" id="chatMessages">
            <div class="msg bot">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ. ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø¥Ø®Ø¨Ø§Ø±Ùƒ Ø¨Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ø¬Ø²ÙŠÙ†ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ†ØŒ Ø£Ùˆ Ø¥Ø¹Ø·Ø§Ø¦Ùƒ Ù†ØµØ§Ø¦Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø²ÙˆÙ†. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡!</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø£Ùˆ Ø§Ù„Ø´ÙØªØ§Øª..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" style="background:var(--primary); border:none; color:white; padding:8px 15px; border-radius:10px; cursor:pointer"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <h2 style="color:var(--primary); text-align:center; letter-spacing:1px;">TALABAT PRO</h2>
        <div class="theme-switch" onclick="toggleTheme()" style="cursor:pointer; padding:10px; background:var(--card-bg); border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between">
            <span id="themeLabel">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</span><i id="themeIcon" class="fa-solid fa-moon"></i>
        </div>
        <nav style="flex:1">
            <a href="/dashboard" class="nav-item active"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="/targets" class="nav-item"><i class="fa-solid fa-chart-line"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±Ø¬Øª</a>
            <a href="/office-wallets" class="nav-item"><i class="fa-solid fa-wallet"></i> Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…ÙƒØªØ¨</a>
            <a href="/reconciliations" class="nav-item"><i class="fa-solid fa-handshake"></i> Ø§Ù„ØªØµØ§Ù„Ø­Ø§Øª</a>
            <a href="/new-riders" class="nav-item"><i class="fa-solid fa-user-plus"></i> Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª</a>
            <a href="/new-riders-responses" class="nav-item"><i class="fa-solid fa-clipboard-check"></i> Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª</a>
            <a href="/rejected-inquiry" class="nav-item"><i class="fa-solid fa-user-xmark"></i> Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ†</a>
            <a href="/order-responses" class="nav-item"><i class="fa-solid fa-file-invoice"></i> Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø§Øª</a>
        </nav>
        <div style="border-top:1px solid var(--glass-border); padding-top:10px">
            <a href="/download" class="nav-item" style="color:var(--success)"><i class="fa-solid fa-file-excel"></i> ØªØ­Ù…ÙŠÙ„ Excel</a>
            <a href="/logout" class="nav-item" style="color:var(--danger)"><i class="fa-solid fa-power-off"></i> Ø®Ø±ÙˆØ¬</a>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-header">
            <div>
                <h1 style="margin:0; font-size: 1.6rem;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„ ğŸš€</h1>
                <p style="color: var(--text-dim); margin-top: 5px;">Ø¥Ù„ÙŠÙƒ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø²ÙˆÙ† Ù„ÙŠÙˆÙ…Ù†Ø§ Ù‡Ø°Ø§</p>
            </div>
            <div class="clock-box">
                <div id="clock">00:00:00</div>
                <div id="date">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>

        <div class="smart-grid">
            <div class="stat-card active" onclick="applyFilter('all', this)"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙˆØ©</span><h2><%= stats.total %></h2></div>
            <div class="stat-card" onclick="applyFilter('hasShift', this)" style="border-bottom-color: var(--success)"><span>Ø­Ø§Ø¬Ø²ÙŠÙ†</span><h2 style="color:var(--success)"><%= stats.withShifts %></h2></div>
            <div class="stat-card" onclick="applyFilter('noShift', this)" style="border-bottom-color: var(--warning)"><span>Ø¨Ø¯ÙˆÙ† Ø´ÙŠÙØª</span><h2 style="color:var(--warning)"><%= stats.noShifts %></h2></div>
            <div class="stat-card" onclick="applyFilter('highWallet', this)" style="border-bottom-color: var(--danger)"><span>Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</span><h2 style="color:var(--danger)"><%= stats.highWallet %></h2></div>
        </div>

        <div class="table-card">
            <table id="tbl">
                <thead>
                    <tr><% headers.forEach((h, index) => { %><th onclick="smartSort(<%= index %>)"><%= h %></th><% }) %></tr>
                </thead>
                <tbody id="tableBody">
                    <% riders.forEach(r => { %>
                    <tr class="rider-row" data-wallet="<%= cleanData(r.get('Ø§Ù„Ù…Ø­ÙØ¸Ù‡')) %>" data-shifts="<%= cleanData(r.get('Ø´ÙŠÙØªØ§Øª Ø§Ù„ØºØ¯')) %>">
                        <% headers.forEach(h => { %> <td><%= r.get(h) || '0' %></td> <% }) %>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </main>

    <div class="news-ticker">
        <div class="ticker-title">Ù†Ø´Ø±Ø© Ø§Ù„ØªÙˆØµÙŠØ§Øª</div>
        <div class="ticker-wrap">
            <div class="ticker-content">
                <span class="ticker-item"><i class="fa-solid fa-triangle-exclamation"></i> Ø§Ù†ØªØ¨Ù‡: ÙŠÙˆØ¬Ø¯ <%= stats.highWallet %> Ù…Ø­Ø§ÙØ¸ Ù…Ù‚ÙÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</span>
                <span class="ticker-item"><i class="fa-solid fa-lightbulb"></i> Ù†ØµÙŠØ­Ø©: Ø®Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ØªÙˆØ±Ø¯ Ø¨Ø§Ù†ØªØ¸Ø§Ù… Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø³ÙˆØ§Ù„Ø¨ Ù…ØªØªØ±Ø§ÙƒÙ…Ø´ Ø¹Ù„ÙŠÙ‡Ù….</span>
                <span class="ticker-item"><i class="fa-solid fa-clock"></i> Ù†ØµÙŠØ­Ø©: Ø®Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ØªØ­Ø¬Ø² Ø´ÙŠÙØªØ§ØªÙ‡Ø§ Ø¨Ø¯Ø±ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø²ÙˆÙ†.</span>
                <span class="ticker-item"><i class="fa-solid fa-ban"></i> Ù…Ù…Ù†ÙˆØ¹: Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙŠØ­Ø¬Ø² Ø§Ù„Ø´ÙŠÙØª ÙŠÙˆÙ…ÙŠ.. Ù„Ø§Ø²Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø·Ø·.</span>
                <span class="ticker-item"><i class="fa-solid fa-chart-line"></i> Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø´ÙŠÙØªØ§Øª Ø§Ù„ÙŠÙˆÙ…: <%= ((stats.noShifts/stats.total)*100).toFixed(1) %>%.</span>
            </div>
        </div>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ar-EG');
            document.getElementById('date').innerText = now.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        setInterval(updateClock, 1000); updateClock();

        function toggleTheme() {
            const b = document.body;
            const isDark = b.getAttribute('data-theme') !== 'light';
            b.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeLabel').innerText = isDark ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
            document.getElementById('themeIcon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function toggleChat() { document.getElementById('chatBox').style.display = (document.getElementById('chatBox').style.display === 'flex') ? 'none' : 'flex'; }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const msg = input.value; if(!msg) return;
            appendMsg(msg, 'user'); input.value = '';
            setTimeout(() => {
                let res = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ. Ù‡Ù„ ØªØ³Ø£Ù„ Ø¹Ù† (Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª) Ø£Ùˆ (Ø§Ù„Ø´ÙŠÙØªØ§Øª)ØŸ";
                if(msg.includes('Ù…Ø¯ÙŠÙˆÙ†')) res = "ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ " + <%= stats.highWallet %> + " Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ÙÙˆÙ‚ Ø§Ù„Ù€ 1000 Ø¬.Ù…. Ø£Ù†ØµØ­ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù… ÙÙˆØ±Ø§Ù‹.";
                if(msg.includes('Ø´ÙŠÙØª')) res = "Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø²ÙŠÙ† Ù‡Ùˆ " + <%= stats.withShifts %> + " ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø­Ø¬Ø² Ù‡ÙŠ " + ((<%= stats.withShifts %>/<%= stats.total %>)*100).toFixed(1) + "%.";
                if(msg.includes('Ù†ØµÙŠØ­Ø©')) res = "Ù†ØµÙŠØ­ØªÙŠ Ù„Ùƒ: Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ù„ÙŠ Ù…Ø¹Ù†Ø¯Ù‡Ù…Ø´ Ø´ÙŠÙØªØ§Øª ÙˆØ¹Ø¯Ø¯Ù‡Ù… " + <%= stats.noShifts %> + " Ù„Ø²ÙŠØ§Ø¯Ø© Ù‚ÙˆØ© Ø§Ù„Ø²ÙˆÙ†.";
                appendMsg(res, 'bot');
            }, 800);
        }

        function appendMsg(t, s) {
            const c = document.getElementById('chatMessages');
            const d = document.createElement('div'); d.className = `msg ${s}`; d.innerText = t;
            c.appendChild(d); c.scrollTop = c.scrollHeight;
        }

        function applyFilter(f, el) {
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.rider-row').forEach(row => {
                const w = parseFloat(row.dataset.wallet) || 0;
                const s = parseFloat(row.dataset.shifts) || 0;
                if (f === 'all') row.style.display = '';
                else if (f === 'hasShift') row.style.display = s > 0 ? '' : 'none';
                else if (f === 'noShift') row.style.display = s === 0 ? '' : 'none';
                else if (f === 'highWallet') row.style.display = w > 1000 ? '' : 'none';
            });
        }

        function smartSort(n) {
            const table = document.getElementById("tbl");
            let rows = Array.from(table.querySelectorAll("tbody tr"));
            let dir = table.getAttribute("data-sort-dir") === "asc" ? "desc" : "asc";
            table.setAttribute("data-sort-dir", dir);
            rows.sort((a, b) => {
                let x = a.cells[n].innerText.replace(/[^\d.-]/g, '');
                let y = b.cells[n].innerText.replace(/[^\d.-]/g, '');
                if(isNaN(parseFloat(x))) { x = a.cells[n].innerText.toLowerCase(); y = b.cells[n].innerText.toLowerCase(); }
                else { x = parseFloat(x); y = parseFloat(y); }
                return dir === "asc" ? (x > y ? 1 : -1) : (x < y ? 1 : -1);
            });
            rows.forEach(r => document.getElementById("tableBody").appendChild(r));
        }
    </script>
</body>
</html>