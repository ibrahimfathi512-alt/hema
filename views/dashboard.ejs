<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talabat Pro | Ultimate AI Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ff5e00;
            --primary-light: #ff8533;
            --bg-gradient: radial-gradient(circle at top right, #1e293b, #070b14);
            --sidebar-bg: rgba(15, 23, 42, 0.98);
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f1c40f;
            --sidebar-width: 280px;
        }

        [data-theme="light"] {
            --bg-gradient: radial-gradient(circle at top right, #f1f5f9, #e2e8f0);
            --sidebar-bg: rgba(255, 255, 255, 0.98);
            --card-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
            --text-main: #1e293b;
            --text-dim: #64748b;
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: var(--bg-gradient); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; overflow-x: hidden; padding-bottom: 75px; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); background: var(--sidebar-bg); backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border); padding: 25px; display: flex;
            flex-direction: column; position: fixed; height: 100vh; right: 0; z-index: 2000;
        }
        .sidebar h2 { color: var(--primary); text-align: center; margin-bottom: 25px; font-size: 1.4rem; letter-spacing: 1px; }

        .nav-item { color: var(--text-dim); text-decoration: none; padding: 12px 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; font-size: 0.9rem; }
        .nav-item:hover, .nav-item.active { background: rgba(255, 94, 0, 0.1); color: var(--primary); transform: translateX(-5px); }

        /* Theme & Header */
        .theme-switch { cursor: pointer; padding: 12px; border-radius: 12px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border: 1px solid var(--glass-border); font-size: 0.85rem; }
        .main-content { margin-right: var(--sidebar-width); flex: 1; padding: 25px; width: calc(100% - var(--sidebar-width)); }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(105%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; }
            .fab-center { display: flex; }
        }

        /* Layout Units */
        .header-layout { display: grid; grid-template-columns: 1fr 280px; gap: 20px; margin-bottom: 25px; }
        .welcome-box { background: var(--card-bg); padding: 25px; border-radius: 24px; border: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; flex: 1; }
        .mini-chart-container { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 24px; padding: 15px; height: 180px; text-align: center; }

        /* Stats & Search */
        .smart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 22px; text-align: center; cursor: pointer; }
        .stat-card.active { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(255, 94, 0, 0.2); }
        .stat-card h2 { margin: 10px 0; font-size: 2.2rem; font-weight: 800; }

        /* --- Floating Center + Button --- */
        .fab-center { 
            position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); 
            width: 70px; height: 70px; background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%; display: none; justify-content: center; align-items: center; 
            z-index: 4000; box-shadow: 0 15px 35px rgba(255, 94, 0, 0.5); color: #fff; 
            font-size: 32px; cursor: pointer; border: 4px solid #fff; animation: pulse 2s infinite;
        }

        /* --- AI Chat & UI --- */
        .chat-fab { position: fixed; bottom: 85px; left: 30px; width: 60px; height: 60px; background: #007bff; border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 3000; cursor: pointer; color: #fff; box-shadow: 0 10px 25px rgba(0,123,255,0.3); }
        .chat-container { position: fixed; bottom: 155px; left: 30px; width: 330px; height: 480px; background: var(--sidebar-bg); border: 1px solid var(--glass-border); border-radius: 24px; display: none; flex-direction: column; z-index: 5000; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .msg { padding: 12px; border-radius: 15px; margin-bottom: 10px; font-size: 0.85rem; max-width: 85%; line-height: 1.4; }
        .msg.bot { background: rgba(255,255,255,0.05); align-self: flex-start; }
        .msg.user { background: var(--primary); align-self: flex-end; }

        /* --- Voice Search Box --- */
        .search-wrapper { position: relative; margin-bottom: 20px; display: flex; gap: 10px; }
        .search-input { flex: 1; padding: 16px 50px; border-radius: 18px; border: 1px solid var(--glass-border); background: var(--card-bg); color: var(--text-main); font-size: 1rem; }
        .voice-btn { width: 55px; height: 55px; background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 18px; color: var(--primary); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .voice-btn.active { background: var(--danger); color: white; animation: pulse-red 1.5s infinite; }

        /* News Ticker */
        .news-ticker { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; color: #fff; height: 45px; display: flex; align-items: center; z-index: 6000; border-top: 2px solid var(--primary); overflow: hidden; }
        .ticker-wrap { flex: 1; overflow: hidden; }
        .ticker-content { display: inline-block; white-space: nowrap; animation: ticker 55s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .ticker-item { display: inline-block; margin: 0 35px; font-size: 0.85rem; }

        /* Table & Badge */
        .table-card { background: var(--card-bg); border-radius: 24px; overflow-x: auto; border: 1px solid var(--glass-border); }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { padding: 18px; color: var(--primary); background: rgba(0,0,0,0.1); cursor: pointer; text-align: center; }
        td { padding: 14px; border-bottom: 1px solid var(--glass-border); text-align: center; }
        .lock-badge { background: var(--danger); color: white; padding: 6px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 94, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 94, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 94, 0, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body data-theme="dark">

    <div class="fab-center" onclick="toggleSidebar()"><i class="fa-solid fa-plus"></i></div>

    <div class="chat-fab" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
    <div class="chat-container" id="chatBox">
        <div style="background:#007bff; padding:15px; color:white; font-weight:bold; display:flex; justify-content:space-between">
            <span>Ù…Ø³Ø§Ø¹Ø¯ ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø°ÙƒÙŠ ğŸ¤–</span><i class="fa-solid fa-xmark" onclick="toggleChat()" style="cursor:pointer"></i>
        </div>
        <div id="chatMessages" style="flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column;">
            <div class="msg bot">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„! ğŸ‘‹ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§ØªØŒ Ø§Ù„Ø´ÙŠÙØªØ§ØªØŒ Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù†ØµÙŠØ­Ø© Ø¥Ø¯Ø§Ø±ÙŠØ© Ù„Ù„Ø²ÙˆÙ†.</div>
        </div>
        <div style="padding:15px; border-top:1px solid var(--glass-border); display:flex; gap:10px;">
            <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." style="flex:1; background:rgba(0,0,0,0.2); border:1px solid var(--glass-border); border-radius:10px; padding:10px; color:white; outline:none;" onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" style="background:var(--primary); border:none; color:white; padding:10px; border-radius:10px; cursor:pointer"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <h2>TALABAT PRO</h2>
        <div class="theme-switch" onclick="toggleTheme()">
            <span id="themeLabel">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</span><i id="themeIcon" class="fa-solid fa-moon"></i>
        </div>
        <nav style="flex:1; overflow-y:auto;">
            <a href="/dashboard" class="nav-item active"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="/targets" class="nav-item"><i class="fa-solid fa-chart-line"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±Ø¬Øª</a>
            <a href="/office-wallets" class="nav-item"><i class="fa-solid fa-wallet"></i> Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…ÙƒØªØ¨</a>
            <a href="/reconciliations" class="nav-item"><i class="fa-solid fa-handshake"></i> Ø§Ù„ØªØµØ§Ù„Ø­Ø§Øª</a>
            <a href="/new-riders" class="nav-item"><i class="fa-solid fa-user-plus"></i> Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª</a>
            <a href="/new-riders-responses" class="nav-item"><i class="fa-solid fa-clipboard-check"></i> Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†Ø§Øª</a>
            <a href="/rejected-inquiry" class="nav-item"><i class="fa-solid fa-user-xmark"></i> Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ†</a>
            <a href="/order-responses" class="nav-item"><i class="fa-solid fa-file-invoice"></i> Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø§Øª</a>
            <div style="margin:10px 0; border-top:1px solid var(--glass-border);"></div>
            <a href="/download" class="nav-item" style="color:var(--success)"><i class="fa-solid fa-file-excel"></i> ØªØ­Ù…ÙŠÙ„ Excel</a>
            <a href="/logout" class="nav-item" style="color:var(--danger)"><i class="fa-solid fa-power-off"></i> Ø®Ø±ÙˆØ¬</a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="header-layout">
            <div class="welcome-box">
                <div>
                    <h1 style="margin:0; font-size: 1.6rem;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„ ğŸš€</h1>
                    <div id="date" style="color: var(--text-dim); margin-top:5px; font-weight:600;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
                <div id="clock" style="font-size: 2.2rem; font-weight: 800; color: var(--primary);">00:00:00</div>
            </div>
            <div class="mini-chart-container">
                <span style="font-size: 0.75rem; color:var(--text-dim); margin-bottom:5px; display:block;">Ù…Ø¤Ø´Ø± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</span>
                <canvas id="miniChart"></canvas>
            </div>
        </div>

        <div class="smart-grid">
            <div class="stat-card active" onclick="applyFilter('all', this)"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙˆØ©</span><h2><%= stats.total %></h2></div>
            <div class="stat-card" onclick="applyFilter('hasShift', this)" style="border-bottom: 4px solid var(--success)"><span>Ø­Ø§Ø¬Ø²ÙŠÙ†</span><h2 style="color:var(--success)"><%= stats.withShifts %></h2></div>
            <div class="stat-card" onclick="applyFilter('noShift', this)" style="border-bottom: 4px solid var(--warning)"><span>Ø¨Ø¯ÙˆÙ† Ø´ÙŠÙØª</span><h2 style="color:var(--warning)"><%= stats.noShifts %></h2></div>
            <div class="stat-card" onclick="applyFilter('highWallet', this)" style="border-bottom: 4px solid var(--danger)"><span>Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</span><h2 style="color:var(--danger)"><%= stats.highWallet %></h2></div>
        </div>

        <div class="search-wrapper">
            <div style="position:relative; flex:1">
                <i class="fa-solid fa-magnifying-glass" style="position:absolute; right:20px; top:18px; color:var(--text-dim)"></i>
                <input type="text" id="searchInput" onkeyup="runGlobalSearch()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ù…Ù†Ø¯ÙˆØ¨ØŒ Ù…Ø´Ø±ÙØŒ Ø£Ùˆ ÙƒÙˆØ¯..." class="search-input">
            </div>
            <button class="voice-btn" id="voiceBtn" onclick="startVoiceSearch()"><i class="fa-solid fa-microphone"></i></button>
        </div>

        <div class="table-card">
            <table id="tbl">
                <thead>
                    <tr><% headers.forEach((h, index) => { %><th onclick="smartSort(<%= index %>)"><%= h %> <i class="fa-solid fa-sort"></i></th><% }) %></tr>
                </thead>
                <tbody id="tableBody">
                    <% riders.forEach(r => { 
                        let wallet = cleanData(r.get('Ø§Ù„Ù…Ø­ÙØ¸Ù‡'));
                        let isLocked = wallet > 1000;
                    %>
                    <tr class="rider-row" data-wallet="<%= wallet %>" data-shifts="<%= cleanData(r.get('Ø´ÙŠÙØªØ§Øª Ø§Ù„ØºØ¯')) %>">
                        <% headers.forEach(h => { 
                            let val = r.get(h) || '0';
                            let isW = (h === 'Ø§Ù„Ù…Ø­ÙØ¸Ù‡');
                        %>
                        <td><% if(isW && isLocked) { %><span class="lock-badge"><i class="fa-solid fa-lock"></i> <%= val %></span><% } else { %><%= val %><% } %></td>
                        <% }) %>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </main>

    <div class="news-ticker">
        <div style="background:var(--primary); padding:0 15px; height:100%; display:flex; align-items:center; font-weight:bold; z-index:2; white-space:nowrap;">Ù†Ø´Ø±Ø© Talabat Pro</div>
        <div class="ticker-wrap">
            <div class="ticker-content">
                <span class="ticker-item"><i class="fa-solid fa-triangle-exclamation"></i> Ø§Ù†ØªØ¨Ù‡: ÙŠÙˆØ¬Ø¯ <%= stats.highWallet %> Ù…Ø­Ø§ÙØ¸ Ù…Ù‚ÙÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.. Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ø·Ù„ÙˆØ¨.</span>
                <span class="ticker-item"><i class="fa-solid fa-lightbulb"></i> Ù†ØµÙŠØ­Ø©: Ø®Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ØªÙˆØ±Ø¯ Ø¨Ø§Ù†ØªØ¸Ø§Ù… Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø³ÙˆØ§Ù„Ø¨ Ù…ØªØªØ±Ø§ÙƒÙ…Ø´ Ø¹Ù„ÙŠÙ‡Ù… ÙˆØªØ¹Ø·Ù„Ù‡Ù… Ø¹Ù† Ø§Ù„Ø´ØºÙ„.</span>
                <span class="ticker-item"><i class="fa-solid fa-calendar-check"></i> Ù†ØµÙŠØ­Ø©: Ø´Ø¬Ø¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ØªØ­Ø¬Ø² Ø´ÙŠÙØªØ§ØªÙ‡Ø§ Ø¨Ø¯Ø±ÙŠ Ø¹Ù„Ø´Ø§Ù† ØªØ¶Ù…Ù† Ù…ÙƒØ§Ù†Ù‡Ø§ ÙˆØªÙˆØ²Ø¹ Ù‚ÙˆØ© Ø§Ù„Ø²ÙˆÙ† ØµØ­.</span>
                <span class="ticker-item"><i class="fa-solid fa-ban"></i> ØªØ°ÙƒÙŠØ±: Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙŠØ­Ø¬Ø² Ø§Ù„Ø´ÙŠÙØª ÙŠÙˆÙ…ÙŠ.. Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø·Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹ Ù‡Ùˆ Ø§Ù„Ø£Ø³Ø§Ø³.</span>
                <span class="ticker-item"><i class="fa-solid fa-chart-pie"></i> Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ø¬Ø²ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹: <%= ((stats.withShifts/stats.total)*100).toFixed(1) %>%.</span>
                <span class="ticker-item"><i class="fa-solid fa-user-clock"></i> ÙŠÙˆØ¬Ø¯ <%= stats.noShifts %> Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ø¯ÙˆÙ† Ø´ÙŠÙØªØ§Øª.. ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù… Ù„Ø±ÙØ¹ ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</span>
            </div>
        </div>
    </div>

    <script>
        // Ø³Ø§Ø¹Ø© ÙˆØªØ§Ø±ÙŠØ® Ù…Ø¨Ø§Ø´Ø± Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
        function updateDateTime() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ar-EG');
            document.getElementById('date').innerText = now.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        setInterval(updateDateTime, 1000); updateDateTime();

        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†
        function toggleTheme() {
            const b = document.body;
            const isDark = b.getAttribute('data-theme') !== 'light';
            b.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeLabel').innerText = isDark ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
            document.getElementById('themeIcon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function toggleChat() { 
            const box = document.getElementById('chatBox');
            box.style.display = (box.style.display === 'flex') ? 'none' : 'flex';
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
        function startVoiceSearch() {
            const btn = document.getElementById('voiceBtn');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ."); return; }
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'ar-SA';
            recognition.onstart = () => btn.classList.add('active');
            recognition.onend = () => btn.classList.remove('active');
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('searchInput').value = transcript;
                runGlobalSearch();
            };
            recognition.start();
        }

        // Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªÙØ§Ø¹Ù„ÙŠ
        function sendMessage() {
            const input = document.getElementById('userInput');
            const msg = input.value.toLowerCase(); if(!msg) return;
            appendMsg(msg, 'user'); input.value = '';
            setTimeout(() => {
                let res = "Ø¹Ø°Ø±Ø§Ù‹ ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† (Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª)ØŒ (Ø§Ù„Ø´ÙŠÙØªØ§Øª)ØŒ Ø£Ùˆ Ø§Ø·Ù„Ø¨ (Ù†ØµÙŠØ­Ø©).";
                if(msg.includes('Ù…Ø¯ÙŠÙˆÙ†')) res = "ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ " + <%= stats.highWallet %> + " Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ÙÙˆÙ‚ Ø§Ù„Ù€ 1000 Ø¬.Ù…. Ù„Ø§Ø²Ù… ØªØ­ØµÙŠÙ„ ÙÙˆØ±ÙŠ Ù„ÙØªØ­ Ø§Ù„Ù…Ø­Ø§ÙØ¸.";
                if(msg.includes('Ø´ÙŠÙØª')) res = "Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø²ÙŠÙ† Ù‡Ùˆ " + <%= stats.withShifts %> + " ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠÙˆÙ… ÙˆØµÙ„Øª Ù„Ù€ " + ((<%= stats.withShifts %>/<%= stats.total %>)*100).toFixed(1) + "%.";
                if(msg.includes('Ù†ØµÙŠØ­Ø©')) res = "Ù†ØµÙŠØ­ØªÙŠ Ù„Ùƒ: Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù€ " + <%= stats.noShifts %> + " Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù„ÙŠ Ù…Ø¹Ù†Ø¯Ù‡Ù…Ø´ Ø´ÙŠÙØªØ§Øª Ø¹Ù„Ø´Ø§Ù† ØªØ¶Ù…Ù† ØªØºØ·ÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø²ÙˆÙ†.";
                appendMsg(res, 'bot');
            }, 650);
        }
        function appendMsg(t, s) {
            const c = document.getElementById('chatMessages');
            const d = document.createElement('div'); d.className = `msg ${s}`; d.innerText = t;
            c.appendChild(d); c.scrollTop = c.scrollHeight;
        }

        // Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù…ØµØºØ± (Doughnut)
        const ctx = document.getElementById('miniChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Ø­Ø§Ø¬Ø²ÙŠÙ†', 'Ø¨Ø¯ÙˆÙ†', 'Ù…Ø¯ÙŠÙˆÙ†'],
                datasets: [{
                    data: [<%= stats.withShifts %>, <%= stats.noShifts %>, <%= stats.highWallet %>],
                    backgroundColor: ['#22c55e', '#f1c40f', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '82%', plugins: { legend: { display: false } } }
        });

        // Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø°ÙƒÙŠ
        function applyFilter(f, el) {
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.rider-row').forEach(row => {
                const w = parseFloat(row.dataset.wallet) || 0;
                const s = parseFloat(row.dataset.shifts) || 0;
                if (f === 'all') row.style.display = '';
                else if (f === 'hasShift') row.style.display = s > 0 ? '' : 'none';
                else if (f === 'noShift') row.style.display = s === 0 ? '' : 'none';
                else if (f === 'highWallet') row.style.display = w > 1000 ? '' : 'none';
            });
        }

        function runGlobalSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.rider-row').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        function smartSort(n) {
            const table = document.getElementById("tbl");
            let rows = Array.from(table.querySelectorAll("tbody tr"));
            let dir = table.getAttribute("data-sort-dir") === "asc" ? "desc" : "asc";
            table.setAttribute("data-sort-dir", dir);
            rows.sort((a, b) => {
                let x = a.cells[n].innerText.replace(/[^\d.-]/g, '');
                let y = b.cells[n].innerText.replace(/[^\d.-]/g, '');
                if(isNaN(parseFloat(x))) { x = a.cells[n].innerText.toLowerCase(); y = b.cells[n].innerText.toLowerCase(); }
                else { x = parseFloat(x); y = parseFloat(y); }
                return dir === "asc" ? (x > y ? 1 : -1) : (x < y ? 1 : -1);
            });
            rows.forEach(r => document.getElementById("tableBody").appendChild(r));
        }
    </script>
</body>
</html>